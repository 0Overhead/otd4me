<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>OTD4Me ‚Äî Find Your Vehicle</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
<style>
/* ‚îÄ‚îÄ‚îÄ RESET & ROOT ‚îÄ‚îÄ‚îÄ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --navy:       #0F1F3D;
  --navy-mid:   #1B2F52;
  --navy-light: #243B60;
  --white:      #FFFFFF;
  --cream:      #F8F6F1;
  --green:      #00C896;
  --green-dim:  #00A87E;
  --border:     rgba(255,255,255,0.10);
  --border-dark:#E2E8F0;
  --text-dim:   rgba(255,255,255,0.55);
  --text-muted: #64748B;
  --shadow:     0 8px 32px rgba(15,31,61,0.18);
  --shadow-sm:  0 2px 12px rgba(15,31,61,0.10);
  --radius:     16px;
  --radius-sm:  10px;

  /* Timeline colors */
  --hot:        #EF4444;
  --warm:       #F97316;
  --soon:       #EAB308;
  --browsing:   #3B82F6;
}

html, body {
  height: 100%;
  font-family: 'DM Sans', sans-serif;
  background: var(--cream);
  color: var(--navy);
  overflow-x: hidden;
}

/* ‚îÄ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ‚îÄ */
.screen { display: none; min-height: 100vh; flex-direction: column; }
.screen.active { display: flex; }

/* ‚îÄ‚îÄ‚îÄ TOP NAV ‚îÄ‚îÄ‚îÄ */
.top-nav {
  background: var(--navy);
  padding: 0 20px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  flex-shrink: 0;
}

.nav-logo {
  font-family: 'Syne', sans-serif;
  font-size: 20px;
  font-weight: 800;
  color: var(--white);
  letter-spacing: -0.5px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.nav-logo span { color: var(--green); }

.nav-actions { display: flex; align-items: center; gap: 10px; }

.nav-btn {
  background: rgba(255,255,255,0.10);
  color: var(--white);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 7px 14px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  transition: background 0.2s;
}
.nav-btn:hover { background: rgba(255,255,255,0.18); }
.nav-btn.primary {
  background: var(--green);
  border-color: var(--green);
  color: var(--navy);
  font-weight: 600;
}
.nav-btn.primary:hover { background: var(--green-dim); }

/* ‚îÄ‚îÄ‚îÄ FEED TOGGLE ‚îÄ‚îÄ‚îÄ */
.feed-toggle-bar {
  background: var(--navy);
  padding: 0 20px 16px;
  display: flex;
  gap: 8px;
}

.feed-toggle {
  flex: 1;
  padding: 10px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-dim);
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}
.feed-toggle.active {
  background: var(--green);
  border-color: var(--green);
  color: var(--navy);
  font-weight: 600;
}

/* ‚îÄ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ‚îÄ */
.filter-bar {
  background: var(--white);
  border-bottom: 1px solid var(--border-dark);
  padding: 12px 16px;
  display: flex;
  gap: 8px;
  overflow-x: auto;
  scrollbar-width: none;
  flex-shrink: 0;
}
.filter-bar::-webkit-scrollbar { display: none; }

.filter-chip {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 7px 12px;
  border-radius: 20px;
  border: 1.5px solid var(--border-dark);
  background: var(--white);
  font-size: 13px;
  font-weight: 500;
  color: var(--navy);
  white-space: nowrap;
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  transition: all 0.15s;
}
.filter-chip.active, .filter-chip:hover {
  background: var(--navy);
  border-color: var(--navy);
  color: var(--white);
}
.filter-chip svg { width: 14px; height: 14px; }

/* ‚îÄ‚îÄ‚îÄ FEED SCROLL AREA ‚îÄ‚îÄ‚îÄ */
.feed-scroll {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* ‚îÄ‚îÄ‚îÄ VEHICLE CARD ‚îÄ‚îÄ‚îÄ */
.vehicle-card {
  background: var(--white);
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-dark);
  transition: transform 0.2s, box-shadow 0.2s;
  cursor: pointer;
}
.vehicle-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }

/* Photo Swiper */
.photo-swiper {
  position: relative;
  width: 100%;
  aspect-ratio: 16/10;
  background: #1a1a2e;
  overflow: hidden;
}
.photo-swiper img {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  opacity: 0;
  transition: opacity 0.3s;
}
.photo-swiper img.active { opacity: 1; }

.photo-dots {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 5px;
}
.photo-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: rgba(255,255,255,0.5);
  transition: background 0.2s, width 0.2s;
}
.photo-dot.active { background: var(--white); width: 14px; border-radius: 3px; }

.photo-arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.4);
  border: none;
  color: white;
  width: 32px; height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 16px;
  z-index: 2;
  transition: background 0.2s;
}
.photo-arrow:hover { background: rgba(0,0,0,0.7); }
.photo-arrow.left { left: 10px; }
.photo-arrow.right { right: 10px; }

.photo-count {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(0,0,0,0.55);
  color: white;
  font-size: 12px;
  font-weight: 500;
  padding: 3px 8px;
  border-radius: 10px;
}

.dealer-badge {
  position: absolute;
  top: 10px;
  left: 10px;
  background: var(--green);
  color: var(--navy);
  font-size: 11px;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 6px;
  letter-spacing: 0.3px;
}

/* Card Body */
.vc-body { padding: 14px 16px 0; }

.vc-price {
  font-family: 'Syne', sans-serif;
  font-size: 22px;
  font-weight: 800;
  color: var(--navy);
  display: flex;
  align-items: baseline;
  gap: 6px;
}
.vc-price-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--green-dim);
  font-family: 'DM Sans', sans-serif;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.vc-title {
  font-size: 17px;
  font-weight: 600;
  color: var(--navy);
  margin: 2px 0 6px;
}

.vc-meta {
  display: flex;
  gap: 12px;
  font-size: 13px;
  color: var(--text-muted);
  margin-bottom: 12px;
  flex-wrap: wrap;
}
.vc-meta span { display: flex; align-items: center; gap: 3px; }

/* Card Actions */
.vc-actions {
  display: flex;
  gap: 0;
  border-top: 1px solid var(--border-dark);
}
.vc-action-btn {
  flex: 1;
  padding: 12px 8px;
  border: none;
  background: transparent;
  font-family: 'DM Sans', sans-serif;
  font-size: 13px;
  font-weight: 500;
  color: var(--navy);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  transition: background 0.15s;
  border-right: 1px solid var(--border-dark);
}
.vc-action-btn:last-child { border-right: none; }
.vc-action-btn:hover { background: var(--cream); }
.vc-action-btn.primary { color: var(--green-dim); font-weight: 600; }
.vc-action-btn svg { width: 16px; height: 16px; }

/* Expandable details */
.vc-details {
  display: none;
  padding: 14px 16px;
  border-top: 1px solid var(--border-dark);
  background: var(--cream);
  font-size: 14px;
  color: var(--navy);
  line-height: 1.7;
}
.vc-details.open { display: block; }
.vc-detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px 16px;
  margin-bottom: 10px;
}
.vc-detail-row { display: flex; flex-direction: column; }
.vc-detail-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); font-weight: 600; }
.vc-detail-value { font-size: 15px; font-weight: 500; color: var(--navy); }

/* ‚îÄ‚îÄ‚îÄ BUYER REQUEST CARD ‚îÄ‚îÄ‚îÄ */
.buyer-card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-dark);
  border-left-width: 4px;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  position: relative;
}
.buyer-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }

.buyer-card.timeline-hot    { border-left-color: var(--hot); }
.buyer-card.timeline-warm   { border-left-color: var(--warm); }
.buyer-card.timeline-soon   { border-left-color: var(--soon); }
.buyer-card.timeline-browse { border-left-color: var(--browsing); }

.bc-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
}
.bc-avatar {
  width: 40px; height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Syne', sans-serif;
  font-size: 15px;
  font-weight: 700;
  color: white;
  flex-shrink: 0;
}

.bc-timeline-badge {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 20px;
  color: white;
}
.timeline-hot .bc-timeline-badge    { background: var(--hot); }
.timeline-warm .bc-timeline-badge   { background: var(--warm); }
.timeline-soon .bc-timeline-badge   { background: var(--soon); color: #333; }
.timeline-browse .bc-timeline-badge { background: var(--browsing); }

.bc-vehicle {
  font-family: 'Syne', sans-serif;
  font-size: 19px;
  font-weight: 700;
  color: var(--navy);
  margin-bottom: 4px;
  line-height: 1.2;
}
.bc-sub {
  font-size: 13px;
  color: var(--text-muted);
  margin-bottom: 10px;
}

.bc-stats {
  display: flex;
  gap: 16px;
  margin-bottom: 12px;
}
.bc-stat {
  display: flex;
  flex-direction: column;
}
.bc-stat-val {
  font-size: 16px;
  font-weight: 600;
  color: var(--navy);
}
.bc-stat-label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.4px;
}

.bc-summary {
  font-size: 14px;
  color: #475569;
  line-height: 1.5;
  font-style: italic;
  border-left: 3px solid var(--border-dark);
  padding-left: 10px;
  margin-bottom: 12px;
}

.bc-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.bc-location { font-size: 13px; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
.bc-message-btn {
  background: var(--navy);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: background 0.2s;
}
.bc-message-btn:hover { background: var(--navy-light); }

/* Priority type tag */
.bc-priority {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  font-weight: 500;
  padding: 3px 8px;
  border-radius: 6px;
  background: var(--cream);
  color: var(--text-muted);
  margin-bottom: 8px;
}

/* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
.empty-state {
  text-align: center;
  padding: 60px 24px;
  color: var(--text-muted);
}
.empty-state-icon { font-size: 48px; margin-bottom: 16px; }
.empty-state-title { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 700; color: var(--navy); margin-bottom: 8px; }
.empty-state-sub { font-size: 15px; line-height: 1.6; margin-bottom: 24px; }
.empty-state-btn {
  background: var(--navy);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: var(--radius-sm);
  font-family: 'DM Sans', sans-serif;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
}
.empty-state-btn:hover { background: var(--navy-light); }

/* ‚îÄ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ‚îÄ */
.bottom-nav {
  background: var(--white);
  border-top: 1px solid var(--border-dark);
  display: flex;
  position: sticky;
  bottom: 0;
  z-index: 100;
  flex-shrink: 0;
}
.bottom-nav-btn {
  flex: 1;
  padding: 10px 8px 12px;
  border: none;
  background: transparent;
  font-family: 'DM Sans', sans-serif;
  font-size: 11px;
  font-weight: 500;
  color: var(--text-muted);
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  transition: color 0.15s;
  position: relative;
}
.bottom-nav-btn.active { color: var(--navy); }
.bottom-nav-btn.active svg { color: var(--navy); }
.bottom-nav-btn svg { width: 22px; height: 22px; color: var(--text-muted); transition: color 0.15s; }
.bottom-nav-btn.active svg { color: var(--navy); }
.bnb-dot {
  position: absolute;
  top: 8px;
  right: 22px;
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--hot);
  border: 2px solid var(--white);
}

/* ‚îÄ‚îÄ‚îÄ AI CHAT SCREEN ‚îÄ‚îÄ‚îÄ */
.chat-screen-inner {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.chat-header {
  background: var(--navy);
  padding: 16px 20px;
  color: white;
  flex-shrink: 0;
}
.chat-header-title {
  font-family: 'Syne', sans-serif;
  font-size: 18px;
  font-weight: 700;
}
.chat-header-sub { font-size: 13px; color: var(--text-dim); margin-top: 2px; }

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  background: var(--cream);
}

.chat-bubble {
  max-width: 82%;
  padding: 12px 15px;
  border-radius: 18px;
  font-size: 15px;
  line-height: 1.5;
}
.chat-bubble.ai {
  background: var(--white);
  color: var(--navy);
  border-bottom-left-radius: 4px;
  align-self: flex-start;
  box-shadow: var(--shadow-sm);
}
.chat-bubble.user {
  background: var(--navy);
  color: white;
  border-bottom-right-radius: 4px;
  align-self: flex-end;
}
.chat-bubble.ai .ai-label {
  font-size: 11px;
  font-weight: 700;
  color: var(--green-dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.chat-typing {
  display: flex;
  gap: 4px;
  align-items: center;
  padding: 12px 15px;
  background: var(--white);
  border-radius: 18px;
  border-bottom-left-radius: 4px;
  align-self: flex-start;
  width: fit-content;
  box-shadow: var(--shadow-sm);
}
.chat-typing span {
  width: 7px; height: 7px;
  background: var(--text-muted);
  border-radius: 50%;
  animation: typing 1.2s infinite;
}
.chat-typing span:nth-child(2) { animation-delay: 0.2s; }
.chat-typing span:nth-child(3) { animation-delay: 0.4s; }
@keyframes typing { 0%,60%,100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-5px); opacity: 1; } }

/* Live card preview */
.card-preview {
  background: var(--white);
  border-radius: var(--radius);
  padding: 14px;
  margin: 4px 0;
  border: 2px solid var(--green);
  align-self: flex-start;
  max-width: 82%;
}
.card-preview-label {
  font-size: 11px;
  font-weight: 700;
  color: var(--green-dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}
.card-preview-field {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
  border-bottom: 1px solid var(--border-dark);
  font-size: 13px;
}
.card-preview-field:last-child { border-bottom: none; }
.cpf-key { color: var(--text-muted); }
.cpf-val { font-weight: 600; color: var(--navy); }

/* Quick reply chips */
.quick-replies {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  padding: 0 16px 8px;
  background: var(--cream);
}
.quick-reply {
  padding: 8px 14px;
  border-radius: 20px;
  border: 1.5px solid var(--navy);
  background: transparent;
  color: var(--navy);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  transition: all 0.15s;
  white-space: nowrap;
}
.quick-reply:hover { background: var(--navy); color: white; }

.chat-input-bar {
  background: var(--white);
  padding: 12px 16px;
  display: flex;
  gap: 10px;
  align-items: flex-end;
  border-top: 1px solid var(--border-dark);
  flex-shrink: 0;
}
.chat-input {
  flex: 1;
  border: 1.5px solid var(--border-dark);
  border-radius: 22px;
  padding: 10px 16px;
  font-family: 'DM Sans', sans-serif;
  font-size: 15px;
  color: var(--navy);
  background: var(--cream);
  resize: none;
  max-height: 100px;
  overflow-y: auto;
  line-height: 1.4;
  outline: none;
}
.chat-input:focus { border-color: var(--navy); }
.chat-send-btn {
  width: 42px; height: 42px;
  border-radius: 50%;
  background: var(--navy);
  border: none;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: background 0.2s;
}
.chat-send-btn:hover { background: var(--navy-light); }
.chat-send-btn:disabled { background: var(--border-dark); cursor: not-allowed; }

/* ‚îÄ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ‚îÄ */
.auth-screen-inner {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  background: var(--navy);
  min-height: 100vh;
}
.auth-card {
  background: var(--white);
  border-radius: 20px;
  padding: 32px 28px;
  width: 100%;
  max-width: 400px;
  box-shadow: 0 24px 64px rgba(0,0,0,0.3);
}
.auth-logo {
  text-align: center;
  margin-bottom: 24px;
}
.auth-logo-text {
  font-family: 'Syne', sans-serif;
  font-size: 28px;
  font-weight: 800;
  color: var(--navy);
}
.auth-logo-text span { color: var(--green-dim); }
.auth-logo-sub { font-size: 14px; color: var(--text-muted); margin-top: 4px; }

.auth-title {
  font-family: 'Syne', sans-serif;
  font-size: 22px;
  font-weight: 700;
  color: var(--navy);
  margin-bottom: 6px;
}
.auth-sub { font-size: 14px; color: var(--text-muted); margin-bottom: 20px; }

.auth-input {
  width: 100%;
  border: 1.5px solid var(--border-dark);
  border-radius: var(--radius-sm);
  padding: 12px 14px;
  font-family: 'DM Sans', sans-serif;
  font-size: 15px;
  color: var(--navy);
  background: var(--cream);
  margin-bottom: 12px;
  outline: none;
  transition: border-color 0.2s;
}
.auth-input:focus { border-color: var(--navy); }

.auth-type-toggle {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}
.auth-type-btn {
  flex: 1;
  padding: 10px;
  border-radius: var(--radius-sm);
  border: 1.5px solid var(--border-dark);
  background: transparent;
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.15s;
}
.auth-type-btn.active {
  background: var(--navy);
  border-color: var(--navy);
  color: white;
}

.dealer-fields { display: none; }
.dealer-fields.show { display: block; }

.auth-submit {
  width: 100%;
  background: var(--navy);
  color: white;
  border: none;
  padding: 14px;
  border-radius: var(--radius-sm);
  font-family: 'DM Sans', sans-serif;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 4px;
  transition: background 0.2s;
}
.auth-submit:hover { background: var(--navy-light); }

.auth-switch {
  text-align: center;
  margin-top: 16px;
  font-size: 14px;
  color: var(--text-muted);
}
.auth-switch a { color: var(--navy); font-weight: 600; cursor: pointer; text-decoration: underline; }

.auth-error {
  background: #FEE2E2;
  color: #DC2626;
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  margin-bottom: 12px;
  display: none;
}

.auth-google-btn {
  width: 100%;
  background: white;
  border: 1.5px solid var(--border-dark);
  padding: 12px;
  border-radius: var(--radius-sm);
  font-family: 'DM Sans', sans-serif;
  font-size: 15px;
  font-weight: 500;
  color: var(--navy);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-bottom: 16px;
  transition: background 0.15s;
}
.auth-google-btn:hover { background: var(--cream); }

.auth-divider {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
  font-size: 13px;
  color: var(--text-muted);
}
.auth-divider::before, .auth-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border-dark);
}

/* ‚îÄ‚îÄ‚îÄ DASHBOARD SCREEN ‚îÄ‚îÄ‚îÄ */
.dashboard-tabs {
  background: var(--white);
  border-bottom: 1px solid var(--border-dark);
  display: flex;
  padding: 0 16px;
  flex-shrink: 0;
}
.dash-tab {
  padding: 14px 16px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-muted);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  white-space: nowrap;
  font-family: 'DM Sans', sans-serif;
  transition: all 0.15s;
}
.dash-tab.active {
  color: var(--navy);
  border-bottom-color: var(--navy);
  font-weight: 600;
}

.dash-panel { display: none; flex: 1; overflow-y: auto; padding: 16px; }
.dash-panel.active { display: block; }

.dash-section-title {
  font-family: 'Syne', sans-serif;
  font-size: 16px;
  font-weight: 700;
  color: var(--navy);
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.dash-add-btn {
  background: var(--navy);
  color: white;
  border: none;
  padding: 6px 14px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
}

/* Listing card in dashboard */
.listing-card {
  background: var(--white);
  border: 1px solid var(--border-dark);
  border-radius: var(--radius-sm);
  padding: 14px;
  margin-bottom: 12px;
  display: flex;
  gap: 12px;
  align-items: center;
}
.listing-thumb {
  width: 64px; height: 48px;
  border-radius: 8px;
  background: var(--cream);
  object-fit: cover;
  flex-shrink: 0;
}
.listing-info { flex: 1; min-width: 0; }
.listing-title { font-weight: 600; font-size: 15px; color: var(--navy); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.listing-meta { font-size: 13px; color: var(--text-muted); }
.listing-price { font-weight: 700; color: var(--green-dim); font-size: 15px; white-space: nowrap; }

/* Conversation card */
.convo-card {
  background: var(--white);
  border: 1px solid var(--border-dark);
  border-radius: var(--radius-sm);
  padding: 14px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: background 0.15s;
  display: flex;
  gap: 12px;
  align-items: center;
}
.convo-card:hover { background: var(--cream); }
.convo-avatar {
  width: 44px; height: 44px;
  border-radius: 50%;
  background: var(--navy);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 16px;
  flex-shrink: 0;
}
.convo-info { flex: 1; min-width: 0; }
.convo-name { font-weight: 600; font-size: 15px; color: var(--navy); margin-bottom: 2px; }
.convo-preview { font-size: 13px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.convo-time { font-size: 12px; color: var(--text-muted); white-space: nowrap; }
.convo-unread {
  width: 10px; height: 10px;
  border-radius: 50%;
  background: var(--hot);
  flex-shrink: 0;
}

/* ‚îÄ‚îÄ‚îÄ MESSAGE THREAD SCREEN ‚îÄ‚îÄ‚îÄ */
.msg-thread-header {
  background: var(--navy);
  padding: 14px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}
.msg-back-btn {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  padding: 4px;
}
.msg-thread-title { font-size: 16px; font-weight: 600; color: white; }
.msg-thread-sub { font-size: 12px; color: var(--text-dim); }

.msg-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  background: var(--cream);
}
.msg-bubble {
  max-width: 78%;
  padding: 10px 14px;
  border-radius: 16px;
  font-size: 15px;
  line-height: 1.5;
}
.msg-bubble.sent {
  background: var(--navy);
  color: white;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}
.msg-bubble.received {
  background: var(--white);
  color: var(--navy);
  align-self: flex-start;
  border-bottom-left-radius: 4px;
  box-shadow: var(--shadow-sm);
}
.msg-time { font-size: 11px; color: var(--text-muted); text-align: center; margin: 4px 0; }

.msg-input-bar {
  background: var(--white);
  padding: 12px 16px;
  display: flex;
  gap: 10px;
  align-items: flex-end;
  border-top: 1px solid var(--border-dark);
  flex-shrink: 0;
}
.msg-input {
  flex: 1;
  border: 1.5px solid var(--border-dark);
  border-radius: 22px;
  padding: 10px 16px;
  font-family: 'DM Sans', sans-serif;
  font-size: 15px;
  background: var(--cream);
  outline: none;
  resize: none;
  max-height: 100px;
}
.msg-input:focus { border-color: var(--navy); }
.msg-send-btn {
  width: 42px; height: 42px;
  border-radius: 50%;
  background: var(--navy);
  border: none;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

/* ‚îÄ‚îÄ‚îÄ ADD VEHICLE FORM ‚îÄ‚îÄ‚îÄ */
.form-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 200;
  align-items: flex-end;
}
.form-overlay.open { display: flex; }
.form-sheet {
  background: var(--white);
  border-radius: 20px 20px 0 0;
  padding: 24px 20px 32px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideUp 0.3s ease;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

.form-sheet-handle {
  width: 40px; height: 4px;
  background: var(--border-dark);
  border-radius: 2px;
  margin: 0 auto 20px;
}
.form-sheet-title {
  font-family: 'Syne', sans-serif;
  font-size: 20px;
  font-weight: 700;
  color: var(--navy);
  margin-bottom: 20px;
}
.form-field {
  margin-bottom: 16px;
}
.form-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--navy);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.4px;
}
.form-input, .form-select, .form-textarea {
  width: 100%;
  border: 1.5px solid var(--border-dark);
  border-radius: var(--radius-sm);
  padding: 12px 14px;
  font-family: 'DM Sans', sans-serif;
  font-size: 15px;
  color: var(--navy);
  background: var(--cream);
  outline: none;
  transition: border-color 0.2s;
  appearance: none;
}
.form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--navy); }
.form-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.form-textarea { resize: vertical; min-height: 80px; }

.photo-upload-zone {
  border: 2px dashed var(--border-dark);
  border-radius: var(--radius);
  padding: 24px;
  text-align: center;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
  color: var(--text-muted);
  font-size: 14px;
}
.photo-upload-zone:hover { border-color: var(--navy); background: var(--cream); }
.photo-upload-zone input { display: none; }
.photo-previews { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
.photo-preview-thumb {
  width: 70px; height: 54px;
  border-radius: 8px;
  object-fit: cover;
  border: 2px solid var(--border-dark);
}

.form-submit {
  width: 100%;
  background: var(--navy);
  color: white;
  border: none;
  padding: 15px;
  border-radius: var(--radius-sm);
  font-family: 'DM Sans', sans-serif;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 8px;
  transition: background 0.2s;
}
.form-submit:hover { background: var(--navy-light); }
.form-error {
  background: #FEE2E2;
  color: #DC2626;
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  margin-bottom: 12px;
  display: none;
}

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
.toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--navy);
  color: white;
  padding: 12px 20px;
  border-radius: 24px;
  font-size: 14px;
  font-weight: 500;
  opacity: 0;
  transition: all 0.3s;
  z-index: 300;
  white-space: nowrap;
  pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ‚îÄ‚îÄ‚îÄ UTILITIES ‚îÄ‚îÄ‚îÄ */
.hidden { display: none !important; }
.loading-spinner {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px;
}
.spinner {
  width: 32px; height: 32px;
  border: 3px solid var(--border-dark);
  border-top-color: var(--navy);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
@media (min-width: 640px) {
  .feed-scroll { max-width: 560px; margin: 0 auto; }
  .chat-screen-inner { max-width: 560px; margin: 0 auto; width: 100%; }
  .form-sheet { max-width: 500px; margin: 0 auto; border-radius: 20px; margin-bottom: 20px; }
  .form-overlay { align-items: center; justify-content: center; }
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- SCREEN: FEED                           -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-feed" class="screen active">

  <div class="top-nav">
    <div class="nav-logo">otd<span>4</span>me</div>
    <div class="nav-actions">
      <button class="nav-btn" id="navSignInBtn" onclick="showScreen('auth')">Sign In</button>
      <button class="nav-btn primary hidden" id="navPostBtn" onclick="handlePostClick()">+ Post</button>
    </div>
  </div>

  <div class="feed-toggle-bar">
    <button class="feed-toggle active" id="toggleVehicles" onclick="switchFeed('vehicles')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M5 17H3a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v7a2 2 0 01-2 2h-3M12 17a3 3 0 100 6 3 3 0 000-6zM6 17a3 3 0 100 6 3 3 0 000-6z"/></svg>
      Vehicle Listings
    </button>
    <button class="feed-toggle" id="toggleBuyers" onclick="switchFeed('buyers')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
      Buyer Requests
    </button>
  </div>

  <!-- Filter Bar -->
  <div class="filter-bar" id="vehicleFilters">
    <button class="filter-chip active" onclick="setFilter(this,'all')">All</button>
    <button class="filter-chip" onclick="setFilter(this,'under20')">Under $20k</button>
    <button class="filter-chip" onclick="setFilter(this,'under30')">Under $30k</button>
    <button class="filter-chip" onclick="openFilterModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"/></svg>
      More Filters
    </button>
  </div>

  <div class="filter-bar hidden" id="buyerFilters">
    <button class="filter-chip active" onclick="setFilter(this,'all')">All</button>
    <button class="filter-chip" style="border-color:var(--hot);color:var(--hot);" onclick="setFilter(this,'hot')">üî¥ ASAP</button>
    <button class="filter-chip" style="border-color:var(--warm);color:var(--warm);" onclick="setFilter(this,'warm')">üü† This Month</button>
    <button class="filter-chip" style="border-color:var(--browsing);color:var(--browsing);" onclick="setFilter(this,'browse')">üîµ Browsing</button>
  </div>

  <!-- Vehicle Feed -->
  <div class="feed-scroll" id="vehicleFeed">
    <div class="loading-spinner"><div class="spinner"></div></div>
  </div>

  <!-- Buyer Request Feed -->
  <div class="feed-scroll hidden" id="buyerFeed">
    <div class="loading-spinner"><div class="spinner"></div></div>
  </div>

  <div class="bottom-nav">
    <button class="bottom-nav-btn active" onclick="showScreen('feed')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
      Browse
    </button>
    <button class="bottom-nav-btn" onclick="requireAuth('chat')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
      AI Chat
    </button>
    <button class="bottom-nav-btn" onclick="requireAuth('dashboard')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
      Dashboard
      <div class="bnb-dot hidden" id="msgDot"></div>
    </button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- SCREEN: AI CHAT                        -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-chat" class="screen">
  <div class="top-nav">
    <div class="nav-logo">otd<span>4</span>me</div>
    <button class="nav-btn" onclick="showScreen('feed')">‚Üê Back</button>
  </div>
  <div class="chat-screen-inner">
    <div class="chat-header">
      <div class="chat-header-title">ü§ñ OTD Vehicle Advisor</div>
      <div class="chat-header-sub">I'll help you find the perfect vehicle ¬∑ Ask me anything</div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="quick-replies" id="quickReplies"></div>
    <div class="chat-input-bar">
      <textarea class="chat-input" id="chatInput" placeholder="Type a message..." rows="1"
        onkeydown="handleChatKey(event)" oninput="autoResize(this)"></textarea>
      <button class="chat-send-btn" onclick="sendChatMessage()" id="chatSendBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M22 2L11 13M22 2L15 22 11 13 2 9l20-7z"/></svg>
      </button>
    </div>
  </div>
  <div class="bottom-nav">
    <button class="bottom-nav-btn" onclick="showScreen('feed')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
      Browse
    </button>
    <button class="bottom-nav-btn active" onclick="showScreen('chat')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
      AI Chat
    </button>
    <button class="bottom-nav-btn" onclick="requireAuth('dashboard')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
      Dashboard
    </button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- SCREEN: AUTH                           -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-auth" class="screen">
  <div class="auth-screen-inner">
    <div class="auth-card">
      <div class="auth-logo">
        <div class="auth-logo-text">otd<span>4</span>me</div>
        <div class="auth-logo-sub">Out-The-Door ¬∑ No Surprises ¬∑ No Games</div>
      </div>

      <!-- LOGIN -->
      <div id="authLogin">
        <div class="auth-title">Welcome back</div>
        <div class="auth-sub">Sign in to your account</div>
        <div class="auth-error" id="loginError"></div>
        <button class="auth-google-btn" onclick="signInGoogle()">
          <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 009 18z"/><path fill="#FBBC05" d="M3.964 10.71A5.41 5.41 0 013.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 000 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 00.957 4.958L3.964 6.29C4.672 4.163 6.656 3.58 9 3.58z"/></svg>
          Continue with Google
        </button>
        <div class="auth-divider">or</div>
        <input class="auth-input" type="email" id="loginEmail" placeholder="Email address" autocomplete="email">
        <input class="auth-input" type="password" id="loginPassword" placeholder="Password" autocomplete="current-password">
        <button class="auth-submit" onclick="signInEmail()" id="loginBtn">Sign In</button>
        <div class="auth-switch">No account? <a onclick="toggleAuthMode('signup')">Create one free</a></div>
      </div>

      <!-- SIGNUP -->
      <div id="authSignup" style="display:none;">
        <div class="auth-title">Create account</div>
        <div class="auth-sub">Free forever for buyers ¬∑ Free to list</div>
        <div class="auth-error" id="signupError"></div>
        <button class="auth-google-btn" onclick="signInGoogle()">
          <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 009 18z"/><path fill="#FBBC05" d="M3.964 10.71A5.41 5.41 0 013.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 000 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 00.957 4.958L3.964 6.29C4.672 4.163 6.656 3.58 9 3.58z"/></svg>
          Sign up with Google
        </button>
        <div class="auth-divider">or</div>

        <!-- User type toggle -->
        <div class="auth-type-toggle">
          <button class="auth-type-btn active" id="typePrivate" onclick="setUserType('private')">üë§ Private</button>
          <button class="auth-type-btn" id="typeDealer" onclick="setUserType('dealer')">üè¢ Dealer</button>
        </div>

        <input class="auth-input" type="text" id="signupName" placeholder="Full name" autocomplete="name">
        <input class="auth-input" type="tel" id="signupPhone" placeholder="Phone number" autocomplete="tel">
        <input class="auth-input" type="email" id="signupEmail" placeholder="Email address" autocomplete="email">
        <input class="auth-input" type="password" id="signupPassword" placeholder="Password (min 8 chars)" autocomplete="new-password">

        <!-- Dealer-only fields -->
        <div class="dealer-fields" id="dealerFields">
          <input class="auth-input" type="text" id="dealerName" placeholder="Dealership name">
          <input class="auth-input" type="text" id="dealerLicense" placeholder="CA Dealer License # (e.g. DA12345)">
          <input class="auth-input" type="text" id="dealerCity" placeholder="City, CA">
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:12px;padding:10px;background:var(--cream);border-radius:8px;">
            üîç Dealer accounts are reviewed within 1 business day. You can browse and list immediately ‚Äî your Dealer Badge appears once verified.
          </div>
        </div>

        <button class="auth-submit" onclick="signUpEmail()" id="signupBtn">Create Account ‚Äî Free</button>
        <div class="auth-switch">Already have an account? <a onclick="toggleAuthMode('login')">Sign in</a></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- SCREEN: DASHBOARD                      -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-dashboard" class="screen">
  <div class="top-nav">
    <div class="nav-logo">otd<span>4</span>me</div>
    <div class="nav-actions">
      <span style="font-size:14px;color:var(--text-dim);" id="dashGreeting"></span>
      <button class="nav-btn" onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <div class="dashboard-tabs">
    <div class="dash-tab active" id="dashTab-listings" onclick="showDashTab('listings')">My Listings</div>
    <div class="dash-tab" id="dashTab-request" onclick="showDashTab('request')">My Request</div>
    <div class="dash-tab" id="dashTab-saved" onclick="showDashTab('saved')">Saved</div>
    <div class="dash-tab" id="dashTab-messages" onclick="showDashTab('messages')">Messages <span id="unreadBadge" class="hidden" style="background:var(--hot);color:white;font-size:11px;padding:1px 6px;border-radius:8px;margin-left:4px;"></span></div>
  </div>

  <!-- My Listings -->
  <div class="dash-panel active" id="dashPanel-listings">
    <div class="dash-section-title">
      My Vehicle Listings
      <button class="dash-add-btn" onclick="openAddVehicle()">+ Add Vehicle</button>
    </div>
    <div id="myListings"><div class="loading-spinner"><div class="spinner"></div></div></div>
  </div>

  <!-- My Request -->
  <div class="dash-panel" id="dashPanel-request">
    <div class="dash-section-title">
      My Buyer Request
      <button class="dash-add-btn" onclick="showScreen('chat')">+ AI Chat</button>
    </div>
    <div id="myRequest"><div class="loading-spinner"><div class="spinner"></div></div></div>
  </div>

  <!-- Saved Vehicles -->
  <div class="dash-panel" id="dashPanel-saved">
    <div class="dash-section-title">Saved Vehicles</div>
    <div id="savedVehicles"><div class="loading-spinner"><div class="spinner"></div></div></div>
  </div>

  <!-- Messages -->
  <div class="dash-panel" id="dashPanel-messages">
    <div class="dash-section-title">Messages</div>
    <div id="messagesList"><div class="loading-spinner"><div class="spinner"></div></div></div>
  </div>

  <div class="bottom-nav">
    <button class="bottom-nav-btn" onclick="showScreen('feed')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
      Browse
    </button>
    <button class="bottom-nav-btn" onclick="showScreen('chat')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
      AI Chat
    </button>
    <button class="bottom-nav-btn active" onclick="showScreen('dashboard')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
      Dashboard
    </button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- SCREEN: MESSAGE THREAD                 -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-thread" class="screen">
  <div class="msg-thread-header">
    <button class="msg-back-btn" onclick="showScreen('dashboard'); showDashTab('messages')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
    </button>
    <div>
      <div class="msg-thread-title" id="threadTitle">Conversation</div>
      <div class="msg-thread-sub" id="threadSub"></div>
    </div>
  </div>
  <div class="msg-messages" id="threadMessages"></div>
  <div class="msg-input-bar">
    <textarea class="msg-input" id="threadInput" placeholder="Type a message..." rows="1"
      onkeydown="handleThreadKey(event)" oninput="autoResize(this)"></textarea>
    <button class="msg-send-btn" onclick="sendThreadMessage()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M22 2L11 13M22 2L15 22 11 13 2 9l20-7z"/></svg>
    </button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- ADD VEHICLE FORM (bottom sheet)        -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="form-overlay" id="addVehicleOverlay" onclick="handleOverlayClick(event)">
  <div class="form-sheet" id="addVehicleSheet">
    <div class="form-sheet-handle"></div>
    <div class="form-sheet-title">List a Vehicle</div>
    <div class="form-error" id="vehicleFormError"></div>
    <div class="form-row-2">
      <div class="form-field">
        <label class="form-label">Year</label>
        <input class="form-input" type="number" id="fYear" placeholder="2021" min="1990" max="2026">
      </div>
      <div class="form-field">
        <label class="form-label">Make</label>
        <input class="form-input" type="text" id="fMake" placeholder="Toyota">
      </div>
    </div>
    <div class="form-row-2">
      <div class="form-field">
        <label class="form-label">Model</label>
        <input class="form-input" type="text" id="fModel" placeholder="Camry">
      </div>
      <div class="form-field">
        <label class="form-label">Trim</label>
        <input class="form-input" type="text" id="fTrim" placeholder="XLE (optional)">
      </div>
    </div>
    <div class="form-row-2">
      <div class="form-field">
        <label class="form-label">Mileage</label>
        <input class="form-input" type="number" id="fMileage" placeholder="38000">
      </div>
      <div class="form-field">
        <label class="form-label">OTD Price ($)</label>
        <input class="form-input" type="number" id="fPrice" placeholder="22500">
      </div>
    </div>
    <div class="form-row-2">
      <div class="form-field">
        <label class="form-label">Zip Code</label>
        <input class="form-input" type="text" id="fZip" placeholder="92590" maxlength="5">
      </div>
      <div class="form-field">
        <label class="form-label">Color</label>
        <input class="form-input" type="text" id="fColor" placeholder="Silver">
      </div>
    </div>
    <div class="form-field">
      <label class="form-label">Description</label>
      <textarea class="form-textarea" id="fDesc" placeholder="Condition, features, service history, anything buyers should know..."></textarea>
    </div>
    <div class="form-field">
      <label class="form-label">Photos (required ‚Äî first photo is main image)</label>
      <div class="photo-upload-zone" onclick="document.getElementById('photoInput').click()">
        <div style="font-size:28px;margin-bottom:6px;">üì∑</div>
        <div>Tap to add photos</div>
        <div style="font-size:12px;margin-top:4px;color:var(--text-muted);">First photo = main image ¬∑ Add more for better results</div>
        <input type="file" id="photoInput" accept="image/*" multiple onchange="handlePhotoSelect(event)">
      </div>
      <div class="photo-previews" id="photoPreviews"></div>
    </div>
    <button class="form-submit" onclick="submitVehicle()" id="vehicleSubmitBtn">List Vehicle ‚Üí</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = 'https://kwpaqhlvqxwfhzmvrrbi.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3cGFxaGx2cXh3Zmh6bXZycmJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODY3MTcsImV4cCI6MjA4NzQ2MjcxN30.ZUZ5Uhw63kfq64Z47DRYfQdM4uJj4xAhOfI5Vwgo12A';

let db;
let currentUser = null;
let currentSession = null;
let currentFeed = 'vehicles';
let activeConversationId = null;
let selectedPhotos = [];
let afterAuthScreen = null;
let chatHistory = [];
let buyerCardData = {};

document.addEventListener('DOMContentLoaded', function() {
  if (!window.supabase) {
    document.body.innerHTML = '<div style="padding:40px;text-align:center;font-size:16px;color:#DC2626;">Failed to load. Please check your connection and refresh.</div>';
    return;
  }
  db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  initApp();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initApp() {
  // Auth state listener
  db.auth.onAuthStateChange((event, session) => {
    currentSession = session;
    currentUser = session?.user || null;
    updateAuthUI();
    if (event === 'SIGNED_IN') {
      if (afterAuthScreen) {
        showScreen(afterAuthScreen);
        afterAuthScreen = null;
      }
    }
  });

  // Check existing session
  const { data: { session } } = await db.auth.getSession();
  currentSession = session;
  currentUser = session?.user || null;
  updateAuthUI();

  // Load feeds
  loadVehicleFeed();
  loadBuyerFeed();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCREEN NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => {
    s.classList.remove('active');
    s.style.display = '';
  });
  const target = document.getElementById('screen-' + name);
  if (target) {
    target.classList.add('active');
    window.scrollTo(0, 0);
  }

  // Load screen-specific data
  if (name === 'dashboard') loadDashboard();
  if (name === 'chat' && chatHistory.length === 0) initChat();
}

function requireAuth(screen) {
  if (currentUser) {
    showScreen(screen);
  } else {
    afterAuthScreen = screen;
    showScreen('auth');
  }
}

function handlePostClick() {
  // If on vehicles tab, open add vehicle; if on buyers tab, go to AI chat
  if (currentFeed === 'vehicles') {
    openAddVehicle();
  } else {
    showScreen('chat');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAuthUI() {
  const signInBtn = document.getElementById('navSignInBtn');
  const postBtn   = document.getElementById('navPostBtn');
  const greeting  = document.getElementById('dashGreeting');

  if (currentUser) {
    signInBtn.classList.add('hidden');
    postBtn.classList.remove('hidden');
    const name = currentUser.user_metadata?.full_name?.split(' ')[0] || 'there';
    if (greeting) greeting.textContent = 'Hi, ' + name + ' üëã';
  } else {
    signInBtn.classList.remove('hidden');
    postBtn.classList.add('hidden');
  }
}

function toggleAuthMode(mode) {
  document.getElementById('authLogin').style.display  = mode === 'login'  ? 'block' : 'none';
  document.getElementById('authSignup').style.display = mode === 'signup' ? 'block' : 'none';
}

function setUserType(type) {
  document.getElementById('typePrivate').classList.toggle('active', type === 'private');
  document.getElementById('typeDealer').classList.toggle('active', type === 'dealer');
  document.getElementById('dealerFields').classList.toggle('show', type === 'dealer');
}

async function signInGoogle() {
  const { error } = await db.auth.signInWithOAuth({
    provider: 'google',
    options: { redirectTo: window.location.href }
  });
  if (error) showAuthError('loginError', error.message);
}

async function signInEmail() {
  const email    = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  if (!email || !password) { showAuthError('loginError', 'Please enter email and password.'); return; }

  const btn = document.getElementById('loginBtn');
  btn.textContent = 'Signing in...';
  btn.disabled = true;

  const { error } = await db.auth.signInWithPassword({ email, password });
  btn.textContent = 'Sign In';
  btn.disabled = false;

  if (error) showAuthError('loginError', error.message);
  else showScreen(afterAuthScreen || 'feed');
}

async function signUpEmail() {
  const name     = document.getElementById('signupName').value.trim();
  const phone    = document.getElementById('signupPhone').value.trim();
  const email    = document.getElementById('signupEmail').value.trim();
  const password = document.getElementById('signupPassword').value;
  const isDealer = document.getElementById('typeDealer').classList.contains('active');

  if (!name)               { showAuthError('signupError', 'Please enter your full name.'); return; }
  if (!phone)              { showAuthError('signupError', 'Please enter your phone number.'); return; }
  if (!email)              { showAuthError('signupError', 'Please enter your email.'); return; }
  if (password.length < 8) { showAuthError('signupError', 'Password must be at least 8 characters.'); return; }

  const metadata = { full_name: name, phone, is_dealer: isDealer };
  if (isDealer) {
    metadata.dealer_name    = document.getElementById('dealerName').value.trim();
    metadata.dealer_license = document.getElementById('dealerLicense').value.trim();
    metadata.dealer_city    = document.getElementById('dealerCity').value.trim();
  }

  const btn = document.getElementById('signupBtn');
  btn.textContent = 'Creating account...';
  btn.disabled = true;

  const { error } = await db.auth.signUp({ email, password, options: { data: metadata } });
  btn.textContent = 'Create Account ‚Äî Free';
  btn.disabled = false;

  if (error) showAuthError('signupError', error.message);
  else {
    showToast('Account created! Check your email to verify.');
    showScreen(afterAuthScreen || 'feed');
  }
}

async function signOut() {
  await db.auth.signOut();
  currentUser = null;
  currentSession = null;
  updateAuthUI();
  showScreen('feed');
  showToast('Signed out successfully');
}

function showAuthError(id, msg) {
  const el = document.getElementById(id);
  if (el) { el.textContent = msg; el.style.display = 'block'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEED
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchFeed(type) {
  currentFeed = type;
  document.getElementById('toggleVehicles').classList.toggle('active', type === 'vehicles');
  document.getElementById('toggleBuyers').classList.toggle('active', type === 'buyers');
  document.getElementById('vehicleFeed').classList.toggle('hidden', type !== 'vehicles');
  document.getElementById('buyerFeed').classList.toggle('hidden', type !== 'buyers');
  document.getElementById('vehicleFilters').classList.toggle('hidden', type !== 'vehicles');
  document.getElementById('buyerFilters').classList.toggle('hidden', type !== 'buyers');

  const postBtn = document.getElementById('navPostBtn');
  if (postBtn && currentUser) {
    postBtn.textContent = type === 'vehicles' ? '+ List Vehicle' : '+ Post Request';
  }
}

function setFilter(el, val) {
  el.closest('.filter-bar').querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  if (currentFeed === 'vehicles') loadVehicleFeed(val);
  else loadBuyerFeed(val);
}

// ‚îÄ‚îÄ Vehicle Feed ‚îÄ‚îÄ
async function loadVehicleFeed(filter) {
  const feed = document.getElementById('vehicleFeed');
  feed.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

  try {
    let query = db.from('vehicles').select('*').eq('status', 'active').order('created_at', { ascending: false });
    if (filter === 'under20') query = query.lte('otd_price', 20000);
    else if (filter === 'under30') query = query.lte('otd_price', 30000);

    const { data, error } = await query;
    if (error) throw error;

    if (!data || data.length === 0) {
      feed.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üöó</div>
          <div class="empty-state-title">No vehicles listed yet</div>
          <div class="empty-state-sub">Be the first to list a vehicle and connect with motivated buyers.</div>
          <button class="empty-state-btn" onclick="requireAuth('dashboard')">List a Vehicle</button>
        </div>`;
      return;
    }

    feed.innerHTML = data.map(v => buildVehicleCard(v)).join('');
    initPhotoSwipers();
  } catch(e) {
    feed.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div class="empty-state-title">Couldn't load vehicles</div><div class="empty-state-sub">${e.message}</div></div>`;
  }
}

function buildVehicleCard(v) {
  const photos = v.photos || [];
  const mainPhoto = photos[0] || '';
  const isDealer = false;
  const isVerified = false;
  const price = v.otd_price ? '$' + Number(v.otd_price).toLocaleString() : 'Price TBD';
  const miles = v.mileage ? Number(v.mileage).toLocaleString() + ' mi' : '';
  const seller = 'Private Seller';

  const photoHTML = photos.length > 0
    ? photos.map((p, i) => `<img src="${p}" class="${i === 0 ? 'active' : ''}" alt="photo ${i+1}" loading="lazy">`).join('')
    : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.3);font-size:40px;">üöó</div>`;

  const dotsHTML = photos.length > 1
    ? '<div class="photo-dots">' + photos.map((_, i) => '<div class="photo-dot' + (i===0?' active':'') + '"></div>').join('') + '</div>'
    : '';

  const arrowsHTML = photos.length > 1
    ? `<button class="photo-arrow left" onclick="swipePhoto(event,this,-1)">‚Äπ</button><button class="photo-arrow right" onclick="swipePhoto(event,this,1)">‚Ä∫</button>`
    : '';

  const countHTML = photos.length > 1 ? `<div class="photo-count">1/${photos.length}</div>` : '';
  const dealerBadge = isDealer ? `<div class="dealer-badge">${isVerified ? '‚úì Verified Dealer' : 'Dealer'}</div>` : '';

  return `
  <div class="vehicle-card" data-id="${v.id}">
    <div class="photo-swiper" ontouchstart="touchStart(event)" ontouchend="touchEnd(event,this)">
      ${photoHTML}
      ${dotsHTML}
      ${arrowsHTML}
      ${countHTML}
      ${dealerBadge}
    </div>
    <div class="vc-body">
      <div class="vc-price">
        ${price}
        <span class="vc-price-label">OTD</span>
      </div>
      <div class="vc-title">${v.year || ''} ${v.make || ''} ${v.model || ''} ${v.trim || ''}</div>
      <div class="vc-meta">
        ${miles ? `<span>üìç ${miles}</span>` : ''}
        ${v.zip_code ? `<span>üìå ${v.zip_code}</span>` : ''}
        <span>üë§ ${seller}</span>
      </div>
    </div>
    <div class="vc-actions">
      <button class="vc-action-btn primary" onclick="startMessage('vehicle','${v.id}','${v.user_id}','${(v.year||'')+' '+(v.make||'')+' '+(v.model||'')}')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        Message
      </button>
      <button class="vc-action-btn" onclick="saveVehicle(event,'${v.id}')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>
        Save
      </button>
      <button class="vc-action-btn" onclick="toggleDetails(this)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
        Details
      </button>
    </div>
    <div class="vc-details">
      <div class="vc-detail-grid">
        ${v.year ? `<div class="vc-detail-row"><span class="vc-detail-label">Year</span><span class="vc-detail-value">${v.year}</span></div>` : ''}
        ${v.make ? `<div class="vc-detail-row"><span class="vc-detail-label">Make</span><span class="vc-detail-value">${v.make}</span></div>` : ''}
        ${v.model ? `<div class="vc-detail-row"><span class="vc-detail-label">Model</span><span class="vc-detail-value">${v.model}</span></div>` : ''}
        ${v.mileage ? `<div class="vc-detail-row"><span class="vc-detail-label">Mileage</span><span class="vc-detail-value">${Number(v.mileage).toLocaleString()} mi</span></div>` : ''}
        ${v.color ? `<div class="vc-detail-row"><span class="vc-detail-label">Color</span><span class="vc-detail-value">${v.color}</span></div>` : ''}
        ${v.otd_price ? `<div class="vc-detail-row"><span class="vc-detail-label">OTD Price</span><span class="vc-detail-value">$${Number(v.otd_price).toLocaleString()}</span></div>` : ''}
      </div>
      ${v.description ? `<div style="font-size:14px;color:#475569;line-height:1.6;">${v.description}</div>` : ''}
    </div>
  </div>`;
}

// ‚îÄ‚îÄ Buyer Feed ‚îÄ‚îÄ
async function loadBuyerFeed(filter) {
  const feed = document.getElementById('buyerFeed');
  feed.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

  try {
    let query = db.from('buyer_requests').select('*').eq('status', 'active').order('created_at', { ascending: false });

    const { data, error } = await query;
    if (error) throw error;

    let cards = data || [];
    if (filter && filter !== 'all') {
      const map = { hot: 'asap', warm: 'this_month', browse: 'browsing' };
      cards = cards.filter(c => c.timeline === (map[filter] || filter));
    }

    if (cards.length === 0) {
      feed.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üîç</div>
          <div class="empty-state-title">No buyer requests yet</div>
          <div class="empty-state-sub">Buyers post specific requests. Use our AI chat to build yours in minutes.</div>
          <button class="empty-state-btn" onclick="requireAuth('chat')">Start My Vehicle Search</button>
        </div>`;
      return;
    }

    feed.innerHTML = cards.map(r => buildBuyerCard(r)).join('');
  } catch(e) {
    feed.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div class="empty-state-title">Couldn't load requests</div><div class="empty-state-sub">${e.message}</div></div>`;
  }
}

function buildBuyerCard(r) {
  const timelineMap = {
    asap:       { cls: 'hot',    label: 'üî¥ ASAP',       color: '#EF4444' },
    this_month: { cls: 'warm',   label: 'üü† This Month',  color: '#F97316' },
    within_60:  { cls: 'soon',   label: 'üü° 60 Days',     color: '#EAB308' },
    browsing:   { cls: 'browse', label: 'üîµ Browsing',    color: '#3B82F6' },
  };
  const tl = timelineMap[r.timeline] || timelineMap['browsing'];
  const initials = ('U').split(' ').map(n => n[0]).join('').slice(0,2).toUpperCase();
  const avatarColors = ['#1B2F52','#0F4C75','#1B6CA8','#065F46','#7C3AED'];
  const avatarColor = avatarColors[r.id?.charCodeAt(0) % avatarColors.length] || avatarColors[0];

  const priorityLabels = {
    specific: 'üéØ Specific Vehicle',
    budget:   'üí∞ Best for Budget',
    reliable: 'üîß Just Needs Reliable',
  };

  const budget = r.max_budget ? '$' + Number(r.max_budget).toLocaleString() : null;
  const mileage = r.max_mileage ? Number(r.max_mileage).toLocaleString() + ' mi max' : null;
  const yearRange = r.year_min && r.year_max ? r.year_min + '‚Äì' + r.year_max : r.year_min ? r.year_min + '+' : null;

  return `
  <div class="buyer-card timeline-${tl.cls}">
    <div class="bc-header">
      <div class="bc-avatar" style="background:${avatarColor}">${initials}</div>
      <div class="bc-timeline-badge">${tl.label}</div>
    </div>
    ${r.priority_type ? `<div class="bc-priority">${priorityLabels[r.priority_type] || r.priority_type}</div>` : ''}
    <div class="bc-vehicle">${r.make || 'Open to suggestions'} ${r.model ? r.model : ''}</div>
    <div class="bc-sub">${[yearRange, mileage].filter(Boolean).join(' ¬∑ ') || 'Flexible on specs'}</div>
    <div class="bc-stats">
      ${budget ? `<div class="bc-stat"><span class="bc-stat-val">${budget}</span><span class="bc-stat-label">Max Budget</span></div>` : ''}
      ${r.zip_code ? `<div class="bc-stat"><span class="bc-stat-val">${r.zip_code}</span><span class="bc-stat-label">Location</span></div>` : ''}
    </div>
    ${r.ai_summary ? `<div class="bc-summary">"${r.ai_summary}"</div>` : ''}
    <div class="bc-footer">
      <span class="bc-location">üìç ${r.zip_code || 'Southern CA'}</span>
      <button class="bc-message-btn" onclick="startMessage('buyer','${r.id}','${r.user_id}','Buyer Request')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        Message Buyer
      </button>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PHOTO SWIPER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let touchStartX = 0;

function initPhotoSwipers() {
  // Already handled by event delegation
}

function swipePhoto(e, btn, dir) {
  e.stopPropagation();
  const swiper = btn.closest('.photo-swiper');
  changePhoto(swiper, dir);
}

function changePhoto(swiper, dir) {
  const imgs = swiper.querySelectorAll('img');
  if (imgs.length < 2) return;
  const dots = swiper.querySelectorAll('.photo-dot');
  const count = swiper.querySelector('.photo-count');
  let current = [...imgs].findIndex(i => i.classList.contains('active'));
  imgs[current].classList.remove('active');
  if (dots[current]) dots[current].classList.remove('active');
  current = (current + dir + imgs.length) % imgs.length;
  imgs[current].classList.add('active');
  if (dots[current]) dots[current].classList.add('active');
  if (count) count.textContent = (current+1) + '/' + imgs.length;
}

function touchStart(e) { touchStartX = e.touches[0].clientX; }
function touchEnd(e, swiper) {
  const diff = touchStartX - e.changedTouches[0].clientX;
  if (Math.abs(diff) > 40) changePhoto(swiper, diff > 0 ? 1 : -1);
}

function toggleDetails(btn) {
  const details = btn.closest('.vehicle-card').querySelector('.vc-details');
  details.classList.toggle('open');
  btn.querySelector('svg').style.transform = details.classList.contains('open') ? 'rotate(180deg)' : '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MESSAGING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startMessage(type, targetId, recipientId, label) {
  if (!currentUser) {
    afterAuthScreen = 'feed';
    showScreen('auth');
    showToast('Sign in to send messages');
    return;
  }
  if (currentUser.id === recipientId) {
    showToast("That's your own listing!");
    return;
  }

  // Find or create conversation
  try {
    const convKey = [currentUser.id, recipientId].sort().join('_') + '_' + targetId;
    let { data: existing } = await db.from('conversations')
      .select('id').eq('conv_key', convKey).single();

    let convId;
    if (existing) {
      convId = existing.id;
    } else {
      const { data: newConv, error } = await db.from('conversations').insert([{
        conv_key:     convKey,
        participant1: currentUser.id,
        participant2: recipientId,
        target_id:    targetId,
        target_type:  type,
        target_label: label,
      }]).select().single();
      if (error) throw error;
      convId = newConv.id;
    }

    activeConversationId = convId;
    document.getElementById('threadTitle').textContent = label;
    document.getElementById('threadSub').textContent = type === 'buyer' ? 'Buyer Request' : 'Vehicle Listing';
    showScreen('thread');
    loadThread(convId);
  } catch(e) {
    showToast('Error starting conversation: ' + e.message);
  }
}

async function loadThread(convId) {
  const container = document.getElementById('threadMessages');
  container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

  const { data, error } = await db.from('messages')
    .select('*')
    .eq('conversation_id', convId)
    .order('created_at', { ascending: true });

  if (error) { container.innerHTML = '<div style="padding:20px;color:red;">Error loading messages</div>'; return; }

  if (!data || data.length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:40px 20px;color:var(--text-muted);">
        <div style="font-size:32px;margin-bottom:12px;">üëã</div>
        <div style="font-size:16px;font-weight:600;color:var(--navy);margin-bottom:6px;">Start the conversation</div>
        <div style="font-size:14px;">Your contact info stays private until you choose to share it.</div>
      </div>`;
    return;
  }

  container.innerHTML = data.map(m => {
    const isMine = m.sender_id === currentUser?.id;
    return `<div class="msg-bubble ${isMine ? 'sent' : 'received'}">${escHtml(m.body)}</div>`;
  }).join('');
  container.scrollTop = container.scrollHeight;
}

async function sendThreadMessage() {
  const input = document.getElementById('threadInput');
  const body = input.value.trim();
  if (!body || !activeConversationId || !currentUser) return;

  input.value = '';
  input.style.height = '';

  const { error } = await db.from('messages').insert([{
    conversation_id: activeConversationId,
    sender_id: currentUser.id,
    body,
  }]);

  if (error) { showToast('Failed to send'); return; }
  loadThread(activeConversationId);
}

function handleThreadKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendThreadMessage(); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE VEHICLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveVehicle(e, vehicleId) {
  e.stopPropagation();
  if (!currentUser) { requireAuth('feed'); return; }

  const { error } = await db.from('saved_vehicles').insert([{
    user_id: currentUser.id,
    vehicle_id: vehicleId,
  }]);

  if (error && error.code === '23505') showToast('Already saved!');
  else if (error) showToast('Error saving vehicle');
  else showToast('Vehicle saved to dashboard ‚úì');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADD VEHICLE FORM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAddVehicle() {
  if (!currentUser) { requireAuth('dashboard'); return; }
  document.getElementById('addVehicleOverlay').classList.add('open');
}

function closeAddVehicle() {
  document.getElementById('addVehicleOverlay').classList.remove('open');
}

function handleOverlayClick(e) {
  if (e.target === document.getElementById('addVehicleOverlay')) closeAddVehicle();
}

function handlePhotoSelect(e) {
  const files = [...e.target.files];
  selectedPhotos = [...selectedPhotos, ...files].slice(0, 8);
  const previews = document.getElementById('photoPreviews');
  previews.innerHTML = '';
  selectedPhotos.forEach(f => {
    const reader = new FileReader();
    reader.onload = ev => {
      const img = document.createElement('img');
      img.src = ev.target.result;
      img.className = 'photo-preview-thumb';
      previews.appendChild(img);
    };
    reader.readAsDataURL(f);
  });
}

async function submitVehicle() {
  const year  = parseInt(document.getElementById('fYear').value);
  const make  = document.getElementById('fMake').value.trim();
  const model = document.getElementById('fModel').value.trim();
  const price = parseInt(document.getElementById('fPrice').value);
  const zip   = document.getElementById('fZip').value.trim();
  const miles = parseInt(document.getElementById('fMileage').value);
  const color = document.getElementById('fColor').value.trim();
  const desc  = document.getElementById('fDesc').value.trim();
  const trim  = document.getElementById('fTrim').value.trim();
  const errEl = document.getElementById('vehicleFormError');
  errEl.style.display = 'none';

  if (!make)  { showFormError('Please enter the make.'); return; }
  if (!model) { showFormError('Please enter the model.'); return; }
  if (!price) { showFormError('Please enter the OTD price.'); return; }
  if (!zip || zip.length !== 5) { showFormError('Please enter a valid 5-digit zip code.'); return; }
  if (selectedPhotos.length === 0) { showFormError('Please add at least one photo.'); return; }

  const btn = document.getElementById('vehicleSubmitBtn');
  btn.textContent = 'Uploading photos...';
  btn.disabled = true;

  try {
    // Upload photos to Supabase Storage
    const photoUrls = [];
    for (let i = 0; i < selectedPhotos.length; i++) {
      const file = selectedPhotos[i];
      const ext = file.name.split('.').pop();
      const path = `vehicles/${currentUser.id}/${Date.now()}_${i}.${ext}`;
      const { data: uploadData, error: uploadErr } = await db.storage
        .from('vehicle-photos')
        .upload(path, file, { upsert: true });
      if (uploadErr) throw uploadErr;
      const { data: { publicUrl } } = db.storage.from('vehicle-photos').getPublicUrl(path);
      photoUrls.push(publicUrl);
    }

    btn.textContent = 'Saving listing...';

    const { error } = await db.from('vehicles').insert([{
      user_id:     currentUser.id,
      year:        year || null,
      make, model, trim: trim || null,
      mileage:     miles || null,
      otd_price:   price,
      zip_code:    zip,
      color:       color || null,
      description: desc || null,
      photos:      photoUrls,
      status:      'active',
    }]);

    if (error) throw error;

    closeAddVehicle();
    showToast('Vehicle listed successfully! üéâ');
    loadVehicleFeed();
    loadDashboard();

    // Reset form
    ['fYear','fMake','fModel','fTrim','fMileage','fPrice','fZip','fColor','fDesc'].forEach(id => {
      document.getElementById(id).value = '';
    });
    selectedPhotos = [];
    document.getElementById('photoPreviews').innerHTML = '';

  } catch(e) {
    showFormError('Error: ' + e.message);
  } finally {
    btn.textContent = 'List Vehicle ‚Üí';
    btn.disabled = false;
  }
}

function showFormError(msg) {
  const el = document.getElementById('vehicleFormError');
  el.textContent = msg;
  el.style.display = 'block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showDashTab(tab) {
  document.querySelectorAll('.dash-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.dash-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('dashTab-' + tab).classList.add('active');
  document.getElementById('dashPanel-' + tab).classList.add('active');
}

async function loadDashboard() {
  if (!currentUser) return;
  loadMyListings();
  loadMyRequest();
  loadSavedVehicles();
  loadMyMessages();
}

async function loadMyListings() {
  const container = document.getElementById('myListings');
  const { data, error } = await db.from('vehicles')
    .select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });

  if (error || !data || data.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding:40px 20px;">
        <div class="empty-state-icon">üöó</div>
        <div class="empty-state-title">No listings yet</div>
        <div class="empty-state-sub">List your first vehicle to start connecting with buyers.</div>
        <button class="empty-state-btn" onclick="openAddVehicle()">+ Add Vehicle</button>
      </div>`;
    return;
  }

  container.innerHTML = data.map(v => `
    <div class="listing-card">
      ${v.photos?.[0] ? `<img class="listing-thumb" src="${v.photos[0]}" alt="vehicle">` : '<div class="listing-thumb" style="display:flex;align-items:center;justify-content:center;font-size:24px;">üöó</div>'}
      <div class="listing-info">
        <div class="listing-title">${v.year||''} ${v.make||''} ${v.model||''}</div>
        <div class="listing-meta">${v.mileage ? Number(v.mileage).toLocaleString()+' mi ¬∑ ' : ''}${v.zip_code||''}</div>
      </div>
      <div class="listing-price">$${Number(v.otd_price||0).toLocaleString()}<br><span style="font-size:11px;color:var(--text-muted);font-weight:400;">OTD</span></div>
    </div>`).join('');
}

async function loadMyRequest() {
  const container = document.getElementById('myRequest');
  const { data, error } = await db.from('buyer_requests')
    .select('*').eq('user_id', currentUser.id).eq('status', 'active').single();

  if (error || !data) {
    container.innerHTML = `
      <div class="empty-state" style="padding:40px 20px;">
        <div class="empty-state-icon">üîç</div>
        <div class="empty-state-title">No active request</div>
        <div class="empty-state-sub">Let our AI help you build your perfect buyer request in minutes.</div>
        <button class="empty-state-btn" onclick="showScreen('chat')">Start AI Chat</button>
      </div>`;
    return;
  }

  const budget = data.max_budget ? '$' + Number(data.max_budget).toLocaleString() : 'Flexible';
  container.innerHTML = `
    <div class="buyer-card timeline-${getTimelineClass(data.timeline)}" style="cursor:default;">
      <div class="bc-vehicle">${data.make||'Open'} ${data.model||''}</div>
      <div class="bc-sub">${[data.year_min&&data.year_max?data.year_min+'‚Äì'+data.year_max:null, data.max_mileage?Number(data.max_mileage).toLocaleString()+' mi max':null].filter(Boolean).join(' ¬∑ ')||'Flexible specs'}</div>
      <div class="bc-stats">
        <div class="bc-stat"><span class="bc-stat-val">${budget}</span><span class="bc-stat-label">Budget</span></div>
        ${data.zip_code?`<div class="bc-stat"><span class="bc-stat-val">${data.zip_code}</span><span class="bc-stat-label">Location</span></div>`:''}
      </div>
      ${data.ai_summary?`<div class="bc-summary">"${data.ai_summary}"</div>`:''}
      <button class="bc-message-btn" style="margin-top:12px;width:100%;justify-content:center;" onclick="showScreen('chat')">‚úèÔ∏è Update with AI Chat</button>
    </div>`;
}

function getTimelineClass(tl) {
  const map = { asap:'hot', this_month:'warm', within_60:'soon', browsing:'browse' };
  return map[tl] || 'browse';
}

async function loadSavedVehicles() {
  const container = document.getElementById('savedVehicles');
  const { data, error } = await db.from('saved_vehicles')
    .select('*, vehicles(*)').eq('user_id', currentUser.id);

  if (error || !data || data.length === 0) {
    container.innerHTML = `<div class="empty-state" style="padding:40px 20px;"><div class="empty-state-icon">üîñ</div><div class="empty-state-title">No saved vehicles</div><div class="empty-state-sub">Tap Save on any vehicle listing to add it here for easy comparison.</div></div>`;
    return;
  }

  container.innerHTML = data.filter(s => s.vehicles).map(s => {
    const v = s.vehicles;
    return `
      <div class="listing-card">
        ${v.photos?.[0] ? `<img class="listing-thumb" src="${v.photos[0]}" alt="vehicle">` : '<div class="listing-thumb" style="display:flex;align-items:center;justify-content:center;font-size:24px;">üöó</div>'}
        <div class="listing-info">
          <div class="listing-title">${v.year||''} ${v.make||''} ${v.model||''}</div>
          <div class="listing-meta">${v.mileage?Number(v.mileage).toLocaleString()+' mi ¬∑ ':''}${v.zip_code||''}</div>
        </div>
        <div class="listing-price">$${Number(v.otd_price||0).toLocaleString()}</div>
      </div>`;
  }).join('');
}

async function loadMyMessages() {
  const container = document.getElementById('messagesList');
  if (!currentUser) return;

  const { data, error } = await db.from('conversations')
    .select('*, messages(body, created_at, sender_id)')
    .or(`participant1.eq.${currentUser.id},participant2.eq.${currentUser.id}`)
    .order('created_at', { ascending: false });

  if (error || !data || data.length === 0) {
    container.innerHTML = `<div class="empty-state" style="padding:40px 20px;"><div class="empty-state-icon">üí¨</div><div class="empty-state-title">No messages yet</div><div class="empty-state-sub">Message a buyer or seller to start a conversation.</div></div>`;
    return;
  }

  container.innerHTML = data.map(conv => {
    const lastMsg = conv.messages?.slice(-1)[0];
    const otherId = conv.participant1 === currentUser.id ? conv.participant2 : conv.participant1;
    const initials = conv.target_label?.slice(0,2).toUpperCase() || '??';
    return `
      <div class="convo-card" onclick="openConversation('${conv.id}','${conv.target_label||''}')">
        <div class="convo-avatar">${initials}</div>
        <div class="convo-info">
          <div class="convo-name">${conv.target_label || 'Conversation'}</div>
          <div class="convo-preview">${lastMsg ? escHtml(lastMsg.body) : 'No messages yet'}</div>
        </div>
        <div class="convo-time">${lastMsg ? timeAgo(lastMsg.created_at) : ''}</div>
      </div>`;
  }).join('');
}

function openConversation(convId, label) {
  activeConversationId = convId;
  document.getElementById('threadTitle').textContent = label || 'Conversation';
  document.getElementById('threadSub').textContent = '';
  showScreen('thread');
  loadThread(convId);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI CHAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initChat() {
  chatHistory = [];
  buyerCardData = {};
  const msgs = document.getElementById('chatMessages');
  msgs.innerHTML = '';

  addAIMessage("Hey! I'm your personal vehicle advisor üöó\n\nI can help you find your perfect vehicle, answer any car questions, and build your buyer request so sellers can find you.\n\nWhat are you looking for today?", [
    'I have a specific vehicle in mind',
    'Help me find the best deal for my budget',
    'I just need something reliable',
    'I have a car question first'
  ]);
}

function addAIMessage(text, quickReplies) {
  const msgs = document.getElementById('chatMessages');

  // Show typing indicator
  const typing = document.createElement('div');
  typing.className = 'chat-typing';
  typing.innerHTML = '<span></span><span></span><span></span>';
  msgs.appendChild(typing);
  msgs.scrollTop = msgs.scrollHeight;

  setTimeout(() => {
    typing.remove();

    const bubble = document.createElement('div');
    bubble.className = 'chat-bubble ai';
    bubble.innerHTML = `<div class="ai-label">ü§ñ OTD Advisor</div>${text.replace(/\n/g, '<br>')}`;
    msgs.appendChild(bubble);

    // Update card preview if data exists
    if (Object.keys(buyerCardData).length > 0) {
      const preview = buildCardPreview();
      msgs.appendChild(preview);
    }

    // Quick replies
    const qr = document.getElementById('quickReplies');
    qr.innerHTML = '';
    if (quickReplies && quickReplies.length > 0) {
      quickReplies.forEach(r => {
        const btn = document.createElement('button');
        btn.className = 'quick-reply';
        btn.textContent = r;
        btn.onclick = () => { sendMessage(r); };
        qr.appendChild(btn);
      });
    }

    msgs.scrollTop = msgs.scrollHeight;
  }, 800 + Math.random() * 400);
}

function buildCardPreview() {
  const div = document.createElement('div');
  div.className = 'card-preview';
  const fields = Object.entries(buyerCardData).map(([k,v]) => `
    <div class="card-preview-field">
      <span class="cpf-key">${k}</span>
      <span class="cpf-val">${v}</span>
    </div>`).join('');
  div.innerHTML = `<div class="card-preview-label">üìã Your Request Card</div>${fields}`;
  return div;
}

function handleChatKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(); }
}

async function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  sendMessage(text);
  input.value = '';
  input.style.height = '';
}

function sendMessage(text) {
  // Clear quick replies
  document.getElementById('quickReplies').innerHTML = '';

  // Add user bubble
  const msgs = document.getElementById('chatMessages');
  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble user';
  bubble.textContent = text;
  msgs.appendChild(bubble);
  msgs.scrollTop = msgs.scrollHeight;

  // Add to history
  chatHistory.push({ role: 'user', content: text });

  // Call AI
  callAI(text);
}

async function callAI(userMessage) {
  const btn = document.getElementById('chatSendBtn');
  btn.disabled = true;

  // Get current vehicle count
  let vehicleCount = 0;
  try {
    const { count } = await db.from('vehicles').select('id', { count: 'exact', head: true }).eq('status','active');
    vehicleCount = count || 0;
  } catch(e) {}

  const msg = userMessage.toLowerCase();

  // Extract info from user message into card
  const budgetMatch = userMessage.match(/\$([\d,]+)k?/i);
  if (budgetMatch) {
    let budget = parseInt(budgetMatch[1].replace(',',''));
    if (userMessage.toLowerCase().includes('k') && budget < 1000) budget *= 1000;
    buyerCardData.max_budget = budget;
  }

  const zipMatch = userMessage.match(/\b(9[0-9]{4}|[0-9]{5})\b/);
  if (zipMatch) buyerCardData.zip_code = zipMatch[0];

  const makes = ['toyota','honda','ford','chevrolet','chevy','nissan','hyundai','kia','bmw','mercedes','audi','subaru','mazda','jeep','ram','gmc','lexus','acura','infiniti','volkswagen','vw','volvo','tesla','dodge','chrysler','buick','cadillac','lincoln','mitsubishi'];
  makes.forEach(make => {
    if (msg.includes(make)) buyerCardData.make = make.charAt(0).toUpperCase() + make.slice(1);
  });

  if (msg.includes('asap') || msg.includes('urgent') || msg.includes('immediately') || msg.includes('right away')) buyerCardData.timeline = 'asap';
  else if (msg.includes('this month') || msg.includes('30 days') || msg.includes('few weeks')) buyerCardData.timeline = 'this_month';
  else if (msg.includes('60 days') || msg.includes('couple months')) buyerCardData.timeline = 'within_60';
  else if (msg.includes('browsing') || msg.includes('just looking') || msg.includes('no rush')) buyerCardData.timeline = 'browsing';

  if (msg.includes('specific') || msg.includes('exact') || msg.includes('know what i want')) buyerCardData.priority_type = 'specific';
  else if (msg.includes('reliable') || msg.includes('just need') || msg.includes('transportation') || msg.includes('get around')) buyerCardData.priority_type = 'reliable';
  else if (msg.includes('budget') || msg.includes('deal') || msg.includes('best value') || msg.includes('most for')) buyerCardData.priority_type = 'budget';

  const mileageMatch = userMessage.match(/(\d{2,3})[,]?(\d{3})\s*miles?/i) || userMessage.match(/under (\d+)k miles/i);
  if (mileageMatch) {
    const miles = mileageMatch[0].match(/\d+/g);
    if (miles) buyerCardData.max_mileage = parseInt(miles.join(''));
  }

  // Build response
  let response = '';
  const hasEnough = buyerCardData.max_budget || buyerCardData.make;
  const quickReplies = [];

  // Honda vs Toyota type questions
  if (msg.includes('honda') && msg.includes('toyota') || msg.includes('reliable') && (msg.includes('which') || msg.includes('better'))) {
    response = "Both Honda and Toyota are excellent choices for reliability ‚Äî consistently ranking at the top in long-term dependability studies. Toyota tends to have slightly lower maintenance costs over time, while Honda often offers a sportier driving feel. For pure reliability and resale value, you really can't go wrong with either. Which matters more to you ‚Äî lower maintenance costs or a more engaging drive?";
    quickReplies.push('Lower maintenance costs', 'More fun to drive', "Doesn't matter, just reliable");
  } else if (msg.includes('otd') || msg.includes('out the door') || msg.includes('out-the-door')) {
    response = "Great question! OTD (out-the-door) price means the total amount you pay including taxes, registration fees, dealer fees, and everything else. No surprises at signing. That's exactly what every listing on OTD4Me is required to show ‚Äî what you see is what you pay.";
    if (!hasEnough) quickReplies.push('Got it, help me find a vehicle', 'Post my request');
  } else if (msg.includes('specific') || msg.includes('know what i want') || msg.includes('exact')) {
    buyerCardData.priority_type = 'specific';
    response = "Perfect ‚Äî knowing exactly what you want makes this easy! What's the year, make, and model you're looking for?";
    quickReplies.push('Tell me the vehicle', 'Show me available vehicles');
  } else if (msg.includes('budget') || msg.includes('best deal') || msg.includes('most for my money')) {
    buyerCardData.priority_type = 'budget';
    response = "Smart approach ‚Äî let's maximize what you get for your money. What's your budget? And are there any makes or body styles you prefer?";
    quickReplies.push('Under $15,000', 'Under $20,000', 'Under $30,000');
  } else if (msg.includes('reliable') || msg.includes('just need') || msg.includes('get around') || msg.includes('transportation')) {
    buyerCardData.priority_type = 'reliable';
    response = "Totally understand ‚Äî you need something dependable without overcomplicating it. What's your budget range? Japanese brands like Toyota, Honda, and Mazda are great for reliability at any price point.";
    quickReplies.push('Under $10,000', 'Under $15,000', 'Under $20,000');
  } else if (msg.includes('post') || msg.includes('submit') || msg.includes('create my request') || msg.includes('save')) {
    if (hasEnough && currentUser) {
      await saveBuyerRequest();
      response = "Your buyer request is now live! üéâ Sellers can see it and message you directly. You stay completely anonymous until you choose to share your contact info.";
    } else if (hasEnough && !currentUser) {
      response = "Almost there! You'll need to create a free account to post your request. It only takes a minute.";
      quickReplies.push('Create account');
      const postBtn = document.querySelector('.empty-state-btn');
    } else {
      response = "Let's finish building your request first. What's your budget and what type of vehicle are you looking for?";
    }
  } else if (budgetMatch) {
    const budget = buyerCardData.max_budget;
    var budgetNote = vehicleCount > 0 ? 'We have ' + vehicleCount + ' vehicles listed right now.' : 'Inventory is growing daily.'; response = 'Got it, budget of $' + Number(budget).toLocaleString() + '. ' + budgetNote + ' What make or type of vehicle are you looking for?';
    quickReplies.push('Toyota', 'Honda', 'Open to anything');
  } else if (zipMatch) {
    var zipNote = vehicleCount > 0 ? vehicleCount + ' vehicles listed right now.' : 'Inventory is growing daily.'; response = 'Got your location (' + zipMatch[0] + '). ' + zipNote + ' What is your budget?';
  } else if (buyerCardData.make && !buyerCardData.max_budget) {
    response = buyerCardData.make + ' is a great choice! What is your budget, and are you flexible on the year or mileage?';
    quickReplies.push('Under $15,000', 'Under $20,000', 'Under $30,000', 'Flexible');
  } else if (hasEnough) {
    var readyNote = vehicleCount > 0 ? vehicleCount + ' vehicles are currently listed.' : ''; response = 'Looking good! Your request is shaping up. ' + readyNote + ' Want to post it now so sellers can find you, or keep adding details?';
    quickReplies.push('Post my request now', 'Add more details', 'What year range?');
  } else {
    // Generic helpful response
    const genericResponses = [
      "Tell me more about what you're looking for ‚Äî a specific vehicle, a budget range, or just a reliable daily driver?",
      "I'm here to help! What's most important to you in your next vehicle ‚Äî reliability, price, specific features, or something else?",
      'Great! We have ' + vehicleCount + ' vehicles listed right now. What type of vehicle or budget are you working with?',
    ];
    response = genericResponses[Math.floor(Math.random() * genericResponses.length)];
    quickReplies.push('I have a specific vehicle in mind', 'Help me find the best deal', 'I just need something reliable');
  }

  chatHistory.push({ role: 'assistant', content: response });
  addAIMessage(response, quickReplies.length > 0 ? quickReplies : undefined);
  btn.disabled = false;
}

async function saveBuyerRequest() {
  if (!currentUser) {
    afterAuthScreen = 'chat';
    showScreen('auth');
    return;
  }

  try {
    // Deactivate old request
    await db.from('buyer_requests').update({ status: 'inactive' }).eq('user_id', currentUser.id);

    const summary = chatHistory.filter(m => m.role === 'user').slice(-3).map(m => m.content).join('. ');

    const { error } = await db.from('buyer_requests').insert([{
      user_id:      currentUser.id,
      priority_type: buyerCardData.priority_type || 'budget',
      make:         buyerCardData.make || null,
      model:        buyerCardData.model || null,
      year_min:     buyerCardData.year_min ? parseInt(buyerCardData.year_min) : null,
      year_max:     buyerCardData.year_max ? parseInt(buyerCardData.year_max) : null,
      max_budget:   buyerCardData.max_budget ? parseInt(buyerCardData.max_budget) : null,
      max_mileage:  buyerCardData.max_mileage ? parseInt(buyerCardData.max_mileage) : null,
      zip_code:     buyerCardData.zip_code || currentUser.user_metadata?.zip || null,
      timeline:     buyerCardData.timeline || 'browsing',
      notes:        buyerCardData.notes || null,
      ai_summary:   summary.slice(0, 200),
      status:       'active',
    }]);

    if (!error) {
      showToast('Your buyer request is live! üéâ');
      loadBuyerFeed();
    }
  } catch(e) {
    console.error('Save error:', e);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function timeAgo(ts) {
  if (!ts) return '';
  const diff = (Date.now() - new Date(ts)) / 1000;
  if (diff < 60) return 'now';
  if (diff < 3600) return Math.floor(diff/60) + 'm';
  if (diff < 86400) return Math.floor(diff/3600) + 'h';
  return Math.floor(diff/86400) + 'd';
}

function escHtml(str) {
  return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function openFilterModal() {
  showToast('Advanced filters coming soon!');
}
</script>
</body>
</html>
